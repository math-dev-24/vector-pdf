# Cursor Rules - Vector PDF Project

## ğŸ“¦ Dependency Management

**Use uv only** for this project:
- `uv sync` â€” install/synchronize dependencies
- `uv run python script.py` â€” run a script with project environment
- `uv add package` â€” add a dependency
- Do not use pip, pipenv, or poetry

## ğŸ—ï¸ Architecture

### Modular Structure
- **`src/core/`**: Core components (config, logging, cache, singletons, retry, metrics)
- **`src/pipeline/`**: Pure business logic (services, models, pipeline)
- **`src/cli/`**: User interface (separate from business logic)
- **`src/extractors/`**: PDF extraction
- **`src/processors/`**: Document processing
- **`src/vectorization/`**: Vectorization and storage

### Architectural Principles
- **DRY**: No code duplication
- **SRP**: One responsibility per class
- **Hexagonal Architecture**: Ports (interfaces) and Adapters (implementations)
- **Dependency Injection**: Services injected into Pipeline

### Separation of Concerns
- **Business services**: Pure logic, no user I/O (no `print()`, `input()`)
- **CLI interface**: User interaction only
- **Pipeline**: Service orchestration

## ğŸ“ Code Conventions

### Configuration
- Use `src.core.settings` for all configuration
- Centralized configuration with Pydantic Settings
- Automatic validation at startup

```python
from src.core import settings
# settings.data_dir, settings.output_dir, etc.
```

### Logging
- Use `get_logger(__name__)` instead of `print()`
- Structured logging with appropriate levels

```python
from src.core import get_logger
logger = get_logger(__name__)
logger.info("Message")
logger.error("Error", exc_info=True)
```

### Error Handling
- Use `PipelineError` with `ErrorType` for business errors
- Automatic error logging

```python
from src.core import PipelineError, ErrorType
raise PipelineError(
    ErrorType.EMBEDDING,
    "Error message",
    original_error=e
)
```

### API Clients
- Use singletons to avoid multiple instantiations

```python
from src.core import OpenAIClient, PineconeClient
client = OpenAIClient().client  # Reused automatically
```

### Retry Logic
- Use `retry_with_backoff` for API calls

```python
from src.core import retry_with_backoff

@retry_with_backoff(max_attempts=3, initial_delay=2.0)
def api_call():
    pass
```

### Cache
- Automatic embedding cache at chunk level
- Use `get_embedding_cache()` to access cache

```python
from src.core.cache import get_embedding_cache
cache = get_embedding_cache()
cached = cache.get(content, model)
cache.set(content, model, embedding)
```

## ğŸ”§ Business Services

### Creating Services
- Inherit from interfaces in `src/pipeline/interfaces.py`
- Pure logic, no user I/O
- Return `Result` objects (ExtractionResult, ChunkingResult, etc.)

```python
from src.pipeline.interfaces import IExtractionService
from src.pipeline.models import ExtractionResult

class ExtractionService(IExtractionService):
    def extract(...) -> ExtractionResult:
        # Pure logic only
        return ExtractionResult(...)
```

### Data Models
- Use dataclasses in `src/pipeline/models.py`
- Use Enums for limited choices

```python
from src.pipeline.models import (
    ExtractionMode,
    PDFFilter,
    ChunkingMode,
    ExtractionResult
)
```

## ğŸ¯ Important Patterns

### Pipeline Pattern
- Pipeline orchestrates services
- Each step returns a Result
- Centralized error handling

```python
from src.pipeline import Pipeline, PipelineConfig

config = PipelineConfig(...)
pipeline = Pipeline(config=config)
result = pipeline.run_full()
```

### Service Pattern
- Independent and testable services
- Dependency injection
- Interfaces for easy mocking

### State Manager
- Use `StateManager` to save/load intermediate states
- Cache for chunks and embeddings

```python
from src.processors import StateManager
state_manager = StateManager(str(settings.cache_dir))
state_manager.save_chunks(results)
state_manager.load_chunks()
```

## ğŸ“ Type Hints

### Always use type hints
- Function parameters and returns
- Important variables
- Use `Optional` for optional values

```python
from typing import List, Dict, Optional
from pathlib import Path

def process(
    data: List[Dict],
    output_dir: Path,
    verbose: bool = True
) -> Optional[Dict]:
    pass
```

## ğŸš« Avoid

### In Business Services
- âŒ `print()` â€” Use `logger`
- âŒ `input()` â€” No user interaction
- âŒ Generic error handling `except Exception`
- âŒ Direct API client instantiation

### In General Code
- âŒ Hardcoded configuration
- âŒ Code duplication
- âŒ Business logic in CLI interface
- âŒ Missing type hints

## âœ… Best Practices

### Clean Code
- Short, focused functions
- Explicit names
- Docstrings for public functions
- Comments for complex logic

### Performance
- Use embedding cache
- Batch processing for APIs
- Multithreading when appropriate (configurable)

### Testing
- Use interfaces for mocks
- Test each service independently
- Unit tests for business logic

## ğŸ”„ Data Flow

### Full Pipeline
```
1. Extraction (ExtractionService)
   PDFs â†’ Markdown

2. Chunking (ChunkingService)
   Markdown â†’ Chunks

3. Embedding (EmbeddingService)
   Chunks â†’ Embeddings (with cache)

4. Storage (StorageService)
   Embeddings â†’ Pinecone
```

## ğŸ“¦ Standard Imports

### Core
```python
from src.core import (
    settings,
    get_logger,
    PipelineError,
    ErrorType,
    OpenAIClient,
    retry_with_backoff,
    MetricsCollector
)
```

### Pipeline
```python
from src.pipeline import (
    Pipeline,
    PipelineConfig,
    ExtractionService,
    ChunkingService,
    EmbeddingService,
    StorageService
)
from src.pipeline.models import (
    ExtractionMode,
    PDFFilter,
    ChunkingMode
)
```

## ğŸ¨ File Structure

### New Service
1. Create interface in `src/pipeline/interfaces.py`
2. Implement in `src/pipeline/services.py`
3. Add Result model in `src/pipeline/models.py`
4. Use in `Pipeline`

### New Core Module
1. Create in `src/core/`
2. Export in `src/core/__init__.py`
3. Document usage

## ğŸ” Key Technical Points

### Configuration
- Pydantic Settings with validation
- Environment variables via `.env`
- Paths automatically converted to `Path`

### Cache
- SHA256 hash to identify chunks
- Optimized directory structure (first 2 characters)
- Cache disable via `EMBEDDING_CACHE_ENABLED`

### Metrics
- `MetricsCollector` to track performance
- API cost estimation
- Error tracking

### Retry
- Configurable exponential backoff
- Automatic attempt logging
- Specific capturable exceptions

## ğŸ“š Documentation

- `README.md`: Installation and usage guide
- `CONTRIBUTING.md`: Contributing guide

## ğŸš€ Useful Commands

### Run pipeline
```bash
uv run python generate.py
```

### Run queries
```bash
uv run python ask.py
```

### Graphical interface
```bash
uv run python ui.py
# or
uv run ocr-vector-ui
```

### Linting
```bash
# Lints are automatic in Cursor
```

## ğŸ’¡ Important Reminders

1. **Always use `settings`** instead of direct environment variables
2. **Logger instead of print** in business code
3. **Interfaces for services** to facilitate testing
4. **Type hints everywhere** for code quality
5. **Pure services** without user I/O
6. **Automatic cache** for embeddings
7. **Retry logic** for APIs
8. **Metrics** to monitor performance
